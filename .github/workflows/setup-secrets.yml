name: Setup Modal Secrets

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      supabase_url:
        description: 'Supabase Project URL'
        required: true
      supabase_anon_key:
        description: 'Supabase Anon Key'
        required: true
      supabase_service_key:
        description: 'Supabase Service Key'
        required: true
      upstash_redis_url:
        description: 'Upstash Redis REST URL'
        required: true
      upstash_redis_token:
        description: 'Upstash Redis REST Token'
        required: true

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Modal
        run: pip install modal

      - name: Create Modal Secret
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: |
          modal secret create uniclass-enterprise-secrets \
            SUPABASE_URL="${{ github.event.inputs.supabase_url }}" \
            SUPABASE_ANON_KEY="${{ github.event.inputs.supabase_anon_key }}" \
            SUPABASE_SERVICE_KEY="${{ github.event.inputs.supabase_service_key }}" \
            UPSTASH_REDIS_URL="${{ github.event.inputs.upstash_redis_url }}" \
            UPSTASH_REDIS_TOKEN="${{ github.event.inputs.upstash_redis_token }}" \
            JWT_SECRET="$(openssl rand -hex 32)" \
            ENVIRONMENT="production"
